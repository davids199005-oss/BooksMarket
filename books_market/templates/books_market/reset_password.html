{% extends "base.html" %}
{% load static %}

{% block title %}Set new password â€” Code Nest{% endblock %}
{% block body_class %}page-auth page-reset-password{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'books_market/css/login.css' %}">
{% endblock %}

{% block content %}
<div class="auth-page page-container">
    <h1 class="auth-title">Set new password</h1>
    <p class="auth-subtitle">Enter your new password below.</p>

    <div id="auth-errors" class="form-errors" role="alert" aria-live="polite" hidden></div>
    <div id="auth-success" class="form-success" role="status" aria-live="polite" hidden></div>

    <form id="reset-form" class="auth-form" method="post" action="#" novalidate>
        {% csrf_token %}
        <input type="hidden" id="id_uid" name="uid" value="{{ uid }}">
        <input type="hidden" id="id_token" name="token" value="{{ token }}">
        <div class="form-group">
            <label for="id_new_password">New password</label>
            <input type="password" id="id_new_password" name="new_password" required autocomplete="new-password" minlength="8" autofocus>
            <span class="field-error" id="err-new_password" aria-live="polite"></span>
        </div>
        <div class="form-group">
            <label for="id_new_password_confirm">Confirm new password</label>
            <input type="password" id="id_new_password_confirm" name="new_password_confirm" required autocomplete="new-password" minlength="8">
            <span class="field-error" id="err-new_password_confirm" aria-live="polite"></span>
        </div>
        <button type="submit" class="btn-auth" id="submit-btn">Change password</button>
    </form>

    <p class="auth-footer">
        <a href="{% url 'login' %}">Back to log in</a>
    </p>
</div>

<script>
(function() {
    const form = document.getElementById('reset-form');
    const errorsBlock = document.getElementById('auth-errors');
    const successBlock = document.getElementById('auth-success');
    const submitBtn = document.getElementById('submit-btn');
    const loginUrl = "{% url 'login' %}";
    const apiUrl = (window.location.origin || '') + '/api/auth/password/reset/confirm/';

    function showError(msg) {
        errorsBlock.textContent = msg || '';
        errorsBlock.hidden = !msg;
        if (msg) successBlock.hidden = true;
    }

    function showSuccess(msg) {
        successBlock.textContent = msg || '';
        successBlock.hidden = !msg;
        if (msg) errorsBlock.hidden = true;
    }

    function setFieldError(field, msg) {
        var el = document.getElementById('err-' + field);
        if (el) el.textContent = msg || '';
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        showError('');
        setFieldError('new_password', '');
        setFieldError('new_password_confirm', '');
        submitBtn.disabled = true;

        var uid = document.getElementById('id_uid').value;
        var token = document.getElementById('id_token').value;
        var newPassword = document.getElementById('id_new_password').value;
        var newPasswordConfirm = document.getElementById('id_new_password_confirm').value;

        if (!uid || !token) {
            showError('Invalid or missing reset link. Please request a new password reset.');
            submitBtn.disabled = false;
            return;
        }
        if (newPassword !== newPasswordConfirm) {
            setFieldError('new_password_confirm', 'Passwords do not match.');
            submitBtn.disabled = false;
            return;
        }

        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                uid: uid,
                token: token,
                new_password: newPassword,
                new_password_confirm: newPasswordConfirm
            })
        })
        .then(function(res) {
            return res.json()
                .then(function(data) { return { ok: res.ok, status: res.status, data: data }; })
                .catch(function() { return { ok: false, status: res.status, data: {} }; });
        })
        .then(function(result) {
            if (result.ok && result.data && result.data.detail) {
                var linkHtml = '<a href="' + loginUrl + '">Log in</a>';
                successBlock.innerHTML = result.data.detail + ' ' + linkHtml;
                successBlock.hidden = false;
                errorsBlock.hidden = true;
                form.style.display = 'none';
                return;
            }
            var msg = result.data.detail || 'Something went wrong. Please try again.';
            if (result.data.new_password && result.data.new_password[0]) {
                setFieldError('new_password', result.data.new_password[0]);
            }
            if (result.data.new_password_confirm && result.data.new_password_confirm[0]) {
                setFieldError('new_password_confirm', result.data.new_password_confirm[0]);
            }
            showError(msg);
        })
        .catch(function() {
            showError('Something went wrong. Please try again.');
        })
        .finally(function() { submitBtn.disabled = false; });
    });
})();
</script>
{% endblock %}
