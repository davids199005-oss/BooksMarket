{% extends "base.html" %}
{% load static %}

{% block title %}Forgot password â€” Code Nest{% endblock %}
{% block body_class %}page-auth page-forgot-password{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'books_market/css/login.css' %}">
{% endblock %}

{% block content %}
<div class="auth-page page-container">
    <h1 class="auth-title">Forgot password</h1>
    <p class="auth-subtitle">Enter your email and we will send you instructions to reset your password.</p>

    <div id="auth-errors" class="form-errors" role="alert" aria-live="polite" hidden></div>
    <div id="auth-success" class="form-success" role="status" aria-live="polite" hidden></div>

    <form id="forgot-form" class="auth-form" method="post" action="#" novalidate>
        {% csrf_token %}
        <div class="form-group">
            <label for="id_email">Email</label>
            <input type="email" id="id_email" name="email" required autocomplete="email" autofocus>
            <span class="field-error" id="err-email" aria-live="polite"></span>
        </div>
        <button type="submit" class="btn-auth" id="submit-btn">Send reset link</button>
    </form>

    <p class="auth-footer">
        <a href="{% url 'login' %}">Back to log in</a>
    </p>
</div>

<script>
(function() {
    const form = document.getElementById('forgot-form');
    const errorsBlock = document.getElementById('auth-errors');
    const successBlock = document.getElementById('auth-success');
    const submitBtn = document.getElementById('submit-btn');
    const apiUrl = (window.location.origin || '') + '/api/auth/password/reset/';

    function showError(msg) {
        errorsBlock.textContent = msg || '';
        errorsBlock.hidden = !msg;
        if (msg) successBlock.hidden = true;
    }

    function showSuccess(msg) {
        successBlock.textContent = msg || '';
        successBlock.hidden = !msg;
        if (msg) errorsBlock.hidden = true;
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        showError('');
        showSuccess('');
        submitBtn.disabled = true;

        var email = document.getElementById('id_email').value.trim();
        if (!email) {
            showError('Enter your email.');
            submitBtn.disabled = false;
            return;
        }

        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(function(res) {
            return res.json()
                .then(function(data) { return { ok: res.ok, status: res.status, data: data }; })
                .catch(function() { return { ok: false, status: res.status, data: {} }; });
        })
        .then(function(result) {
            if (result.ok && result.data && result.data.detail) {
                showSuccess(result.data.detail);
                form.querySelector('#id_email').value = '';
                return;
            }
            showError(result.data.detail || result.data.email && result.data.email[0] || 'Something went wrong. Please try again.');
        })
        .catch(function() {
            showError('Something went wrong. Please try again.');
        })
        .finally(function() { submitBtn.disabled = false; });
    });
})();
</script>
{% endblock %}
