{% extends "base.html" %}
{% load static %}

{% block title %}Register â€” Code Nest{% endblock %}
{% block body_class %}page-auth page-register{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'books_market/css/register.css' %}">
{% endblock %}

{% block content %}
<div class="auth-page page-container">
    <h1 class="auth-title">Register</h1>
    <p class="auth-subtitle">Create an account to continue.</p>

    <div id="auth-errors" class="form-errors" role="alert" aria-live="polite" hidden></div>

    <form id="register-form" class="auth-form" method="post" action="#" novalidate>
        {% csrf_token %}
        <div class="form-group">
            <label for="id_username">Username</label>
            <input type="text" id="id_username" name="username" required autocomplete="username" autofocus>
            <span class="field-error" id="err-username" aria-live="polite"></span>
        </div>
        <div class="form-group">
            <label for="id_email">Email</label>
            <input type="email" id="id_email" name="email" required autocomplete="email">
            <span class="field-error" id="err-email" aria-live="polite"></span>
        </div>
        <div class="form-group">
            <label for="id_password">Password</label>
            <input type="password" id="id_password" name="password" required autocomplete="new-password" minlength="8">
            <span class="field-error" id="err-password" aria-live="polite"></span>
        </div>
        <div class="form-group">
            <label for="id_password_confirm">Confirm password</label>
            <input type="password" id="id_password_confirm" name="password_confirm" required autocomplete="new-password" minlength="8">
            <span class="field-error" id="err-password_confirm" aria-live="polite"></span>
        </div>
        <button type="submit" class="btn-auth" id="submit-btn">Register</button>
    </form>

    <p class="auth-footer">
        Already have an account? <a href="{% url 'login' %}">Log in</a>
    </p>
</div>

<script>
(function() {
    const form = document.getElementById('register-form');
    const errorsBlock = document.getElementById('auth-errors');
    const submitBtn = document.getElementById('submit-btn');
    const loginUrl = "{% url 'login' %}";
    const apiUrl = "{% url 'home' %}".replace(/\/?$/, '') + '/api/auth/register/';

    function showErrors(general, fieldErrors) {
        if (general) {
            errorsBlock.textContent = general;
            errorsBlock.hidden = false;
        } else {
            errorsBlock.hidden = true;
            errorsBlock.textContent = '';
        }
        ['username', 'email', 'password', 'password_confirm'].forEach(function(name) {
            var el = document.getElementById('err-' + name);
            if (el) el.textContent = (fieldErrors && fieldErrors[name] && fieldErrors[name][0]) || '';
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        errorsBlock.hidden = true;
        ['username', 'email', 'password', 'password_confirm'].forEach(function(name) {
            var el = document.getElementById('err-' + name);
            if (el) el.textContent = '';
        });
        submitBtn.disabled = true;

        var body = {
            username: document.getElementById('id_username').value.trim(),
            email: document.getElementById('id_email').value.trim(),
            password: document.getElementById('id_password').value,
            password_confirm: document.getElementById('id_password_confirm').value
        };

        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, status: res.status, data: data }; }); })
        .then(function(result) {
            if (result.ok) {
                window.location.href = loginUrl;
                return;
            }
            var msg = result.data.detail || 'Please fix the errors below.';
            var fieldErrors = result.data;
            if (typeof msg === 'object') msg = 'Please fix the errors below.';
            showErrors(msg, fieldErrors);
        })
        .catch(function() {
            showErrors('Something went wrong. Please try again.');
        })
        .finally(function() { submitBtn.disabled = false; });
    });
})();
</script>
{% endblock %}
